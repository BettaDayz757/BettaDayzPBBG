#!/usr/bin/expect -f

set timeout 120

puts "🚀 BettaDayz PBBG - CloudLinux Compatible Setup"
puts "=============================================="

# Connect and deploy
puts "🔧 Setting up both domains..."
spawn ssh -p 65002 -o StrictHostKeyChecking=no u933155252@194.195.84.72

expect "password:"
send "@Jgallow20\r"

expect "$ " {
    send "cd ~/bettadayz\r"
}

expect "$ " {
    send "echo '🚀 Continuing BettaDayz PBBG Setup...'\r"
}

# Remove the failed Node.js download and try a different approach
expect "$ " {
    send "rm -f node-v18.19.0-linux-x64.tar.xz\r"
}

# Check if Node.js is already available on the system
expect "$ " {
    send "which node\r"
}

expect "$ " {
    send "node --version 2>/dev/null || echo 'Node.js not found'\r"
}

# Download Node.js binary without xz compression
expect "$ " {
    send "echo '📥 Downloading Node.js binary...'\r"
}

expect "$ " {
    send "wget -q https://nodejs.org/dist/v18.19.0/node-v18.19.0-linux-x64.tar.gz\r"
}

expect "$ " {
    send "tar -xzf node-v18.19.0-linux-x64.tar.gz\r"
}

expect "$ " {
    send "rm node-v18.19.0-linux-x64.tar.gz\r"
}

# Set up PATH for current session
expect "$ " {
    send "export PATH=/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin:/usr/bin:/bin\r"
}

# Add to bashrc for persistent PATH
expect "$ " {
    send "echo 'export PATH=/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin:$PATH' >> ~/.bashrc\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/node --version\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/npm --version\r"
}

# Install dependencies
expect "$ " {
    send "echo '📦 Installing dependencies...'\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/npm install --production --legacy-peer-deps\r"
}

# Create environment files
expect "$ " {
    send "echo '⚙️ Configuring environment files...'\r"
}

expect "$ " {
    send "cat > .env.production << 'ENVEOF'\r"
}

expect "$ " {
    send "NODE_ENV=production\r"
}

expect "$ " {
    send "JWT_SECRET=9=N6H//qQ]?g+BDV\r"
}

expect "$ " {
    send "NEXT_PUBLIC_SHOP_DOMAIN=bettadayz.shop\r"
}

expect "$ " {
    send "NEXT_PUBLIC_STORE_DOMAIN=bettadayz.store\r"
}

expect "$ " {
    send "ENVEOF\r"
}

# Create shop environment
expect "$ " {
    send "cp .env.production .env.shop\r"
}

expect "$ " {
    send "echo 'PORT=3000' >> .env.shop\r"
}

expect "$ " {
    send "echo 'NEXT_PUBLIC_DOMAIN=bettadayz.shop' >> .env.shop\r"
}

# Create store environment
expect "$ " {
    send "cp .env.production .env.store\r"
}

expect "$ " {
    send "echo 'PORT=3001' >> .env.store\r"
}

expect "$ " {
    send "echo 'NEXT_PUBLIC_DOMAIN=bettadayz.store' >> .env.store\r"
}

# Install PM2 globally
expect "$ " {
    send "echo '🔧 Installing PM2...'\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/npm install -g pm2\r"
}

# Create PM2 ecosystem
expect "$ " {
    send "cat > ecosystem.config.js << 'PMEOF'\r"
}

expect "$ " {
    send "module.exports = {\r"
}

expect "$ " {
    send "  apps: \\[\r"
}

expect "$ " {
    send "    {\r"
}

expect "$ " {
    send "      name: 'bettadayz-shop',\r"
}

expect "$ " {
    send "      script: '/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/npm',\r"
}

expect "$ " {
    send "      args: 'start',\r"
}

expect "$ " {
    send "      cwd: '/home/u933155252/bettadayz',\r"
}

expect "$ " {
    send "      env: {\r"
}

expect "$ " {
    send "        NODE_ENV: 'production',\r"
}

expect "$ " {
    send "        PORT: 3000,\r"
}

expect "$ " {
    send "        NEXT_PUBLIC_DOMAIN: 'bettadayz.shop',\r"
}

expect "$ " {
    send "        JWT_SECRET: '9=N6H//qQ\\]?g+BDV'\r"
}

expect "$ " {
    send "      }\r"
}

expect "$ " {
    send "    },\r"
}

expect "$ " {
    send "    {\r"
}

expect "$ " {
    send "      name: 'bettadayz-store',\r"
}

expect "$ " {
    send "      script: '/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/npm',\r"
}

expect "$ " {
    send "      args: 'start',\r"
}

expect "$ " {
    send "      cwd: '/home/u933155252/bettadayz',\r"
}

expect "$ " {
    send "      env: {\r"
}

expect "$ " {
    send "        NODE_ENV: 'production',\r"
}

expect "$ " {
    send "        PORT: 3001,\r"
}

expect "$ " {
    send "        NEXT_PUBLIC_DOMAIN: 'bettadayz.store',\r"
}

expect "$ " {
    send "        JWT_SECRET: '9=N6H//qQ\\]?g+BDV'\r"
}

expect "$ " {
    send "      }\r"
}

expect "$ " {
    send "    }\r"
}

expect "$ " {
    send "  \\]\r"
}

expect "$ " {
    send "};\r"
}

expect "$ " {
    send "PMEOF\r"
}

# Start applications
expect "$ " {
    send "echo '🚀 Starting both domains...'\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/pm2 start ecosystem.config.js\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/pm2 save\r"
}

expect "$ " {
    send "/home/u933155252/bettadayz/node-v18.19.0-linux-x64/bin/pm2 status\r"
}

expect "$ " {
    send "echo '✅ Deployment complete!'\r"
}

expect "$ " {
    send "echo 'Shop: http://194.195.84.72:3000'\r"
}

expect "$ " {
    send "echo 'Store: http://194.195.84.72:3001'\r"
}

expect "$ " {
    send "exit\r"
}

expect eof

puts ""
puts "🎉 BettaDayz PBBG Deployment Complete!"
puts "====================================="
puts ""
puts "✅ Both domains should now be running:"
puts "   🎮 Shop: http://194.195.84.72:3000"
puts "   🛒 Store: http://194.195.84.72:3001"