#!/usr/bin/expect -f

set timeout 30
set password "@Jgallow20"

# Connect to server
spawn ssh -p 65002 u933155252@194.195.84.72

# Handle password prompt
expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "$ " {
        # We're in, proceed with deployment
    }
    timeout {
        puts "Connection timeout"
        exit 1
    }
}

# Navigate to project directory
send "cd ~/bettadayz\r"
expect "$ "

# Make setup script executable
send "chmod +x manual-setup-commands.sh\r"
expect "$ "

# Execute the manual setup commands
send "./manual-setup-commands.sh\r"
expect {
    "$ " {
        puts "Setup script completed"
    }
    timeout {
        puts "Setup script timeout"
    }
}

# Start the applications with PM2
send "~/node-v18.19.0-linux-x64/bin/npm install pm2 -g\r"
expect "$ "

send "~/node-v18.19.0-linux-x64/bin/pm2 start ecosystem.config.js\r"
expect "$ "

send "~/node-v18.19.0-linux-x64/bin/pm2 status\r"
expect "$ "

send "~/node-v18.19.0-linux-x64/bin/pm2 logs --lines 10\r"
expect "$ "

puts "ğŸ¯ Deployment Complete!"
puts "âœ… Shop: http://194.195.84.72:3000"
puts "âœ… Store: http://194.195.84.72:3001"
puts "ğŸ” JWT Secret: 9=N6H//qQ]?g+BDV configured"

send "exit\r"
expect eof