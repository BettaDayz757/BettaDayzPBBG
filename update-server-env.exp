#!/usr/bin/expect -f

# BettaDayz PBBG Server Environment Update Script
# Updates production applications with Supabase configuration

set timeout 120
set password "@Jgallow20"

puts "ğŸ”§ BettaDayz PBBG Server Environment Update"
puts "==========================================="
puts "ğŸ” JWT Secret: 9=N6H//qQ]?g+BDV"
puts "ğŸŒ Cloudflare Worker: bettadayz.workers.dev"
puts "ğŸ“Š Updating Supabase configuration..."
puts ""

spawn ssh -p 65002 u933155252@194.195.84.72

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "\$ " {
        # Connected
    }
    timeout {
        puts "Connection timeout"
        exit 1
    }
}

send "cd ~/bettadayz\r"
expect "\$ "

# Backup existing environment files
send "cp .env.production.shop .env.production.shop.backup 2>/dev/null || echo 'No shop env file to backup'\r"
expect "\$ "

send "cp .env.production.store .env.production.store.backup 2>/dev/null || echo 'No store env file to backup'\r"
expect "\$ "

# Update Shop environment
send "cat > .env.production.shop << 'EOF'\r"
expect "> "
send "# BettaDayz PBBG Production - Shop (Port 3000)\r"
expect "> "
send "NODE_ENV=production\r"
expect "> "
send "PORT=3000\r"
expect "> "
send "HOSTNAME=0.0.0.0\r"
expect "> "
send "NEXT_PUBLIC_SITE_URL=https://bettadayz.shop\r"
expect "> "
send "JWT_SECRET=9=N6H//qQ\]?g+BDV\r"
expect "> "
send "NEXTAUTH_SECRET=9=N6H//qQ\]?g+BDV\r"
expect "> "
send "GAME_DOMAIN=shop\r"
expect "> "
send "GAME_NAME=BettaDayz Shop\r"
expect "> "
send "CLOUDFLARE_WORKER_URL=https://bettadayz-pbbg.bettadayz.workers.dev\r"
expect "> "
send "WORKER_TOKEN=after9b9fcaead55610e5dd235878e702ee69\r"
expect "> "
send "ENABLE_MULTIPLAYER=true\r"
expect "> "
send "ENABLE_MARKETPLACE=true\r"
expect "> "
send "ENABLE_GUILDS=true\r"
expect "> "
send "EOF\r"
expect "\$ "

# Update Store environment
send "cat > .env.production.store << 'EOF'\r"
expect "> "
send "# BettaDayz PBBG Production - Store (Port 3001)\r"
expect "> "
send "NODE_ENV=production\r"
expect "> "
send "PORT=3001\r"
expect "> "
send "HOSTNAME=0.0.0.0\r"
expect "> "
send "NEXT_PUBLIC_SITE_URL=https://bettadayz.store\r"
expect "> "
send "JWT_SECRET=9=N6H//qQ\]?g+BDV\r"
expect "> "
send "NEXTAUTH_SECRET=9=N6H//qQ\]?g+BDV\r"
expect "> "
send "GAME_DOMAIN=store\r"
expect "> "
send "GAME_NAME=BettaDayz Store\r"
expect "> "
send "CLOUDFLARE_WORKER_URL=https://bettadayz-pbbg.bettadayz.workers.dev\r"
expect "> "
send "WORKER_TOKEN=after9b9fcaead55610e5dd235878e702ee69\r"
expect "> "
send "ENABLE_MULTIPLAYER=true\r"
expect "> "
send "ENABLE_MARKETPLACE=true\r"
expect "> "
send "ENABLE_GUILDS=false\r"
expect "> "
send "EOF\r"
expect "\$ "

# Install Supabase packages
send "export PATH=/home/u933155252/node-v20.18.0-linux-x64/bin:\$PATH\r"
expect "\$ "

send "npm install @supabase/supabase-js @supabase/auth-helpers-nextjs\r"
expect {
    "\$ " {
        puts "âœ… Supabase packages installed"
    }
    timeout {
        puts "Package installation timeout, continuing..."
        send "\003"
        expect "\$ "
    }
}

# Restart applications with new environment
send "echo 'Stopping current applications...'\r"
expect "\$ "

send "kill \$(cat shop.pid store.pid 2>/dev/null) 2>/dev/null || echo 'No processes to kill'\r"
expect "\$ "

send "sleep 3\r"
expect "\$ "

send "echo 'Starting applications with updated configuration...'\r"
expect "\$ "

send "./start-shop.sh\r"
expect "\$ "

send "./start-store.sh\r"
expect "\$ "

send "sleep 10\r"
expect "\$ "

# Verify applications are running
send "echo '=== APPLICATION STATUS ==='\r"
expect "\$ "

send "ps aux | grep -v grep | grep node\r"
expect "\$ "

send "echo '=== SHOP STATUS ==='\r"
expect "\$ "

send "tail -n 3 logs/shop.log 2>/dev/null || echo 'No shop log yet'\r"
expect "\$ "

send "echo '=== STORE STATUS ==='\r"
expect "\$ "

send "tail -n 3 logs/store.log 2>/dev/null || echo 'No store log yet'\r"
expect "\$ "

# Test HTTP responses
send "echo '=== TESTING APPLICATIONS ==='\r"
expect "\$ "

send "curl -s -w 'Shop Response: %\{http_code\}\\n' http://localhost:3000 | head -1\r"
expect "\$ "

send "curl -s -w 'Store Response: %\{http_code\}\\n' http://localhost:3001 | head -1\r"
expect "\$ "

puts ""
puts "ğŸ¯ BETTADAYZ ENVIRONMENT UPDATE COMPLETE!"
puts "=========================================="
puts "âœ… Shop Environment: Updated with JWT secret"
puts "âœ… Store Environment: Updated with JWT secret"
puts "âœ… Supabase Packages: Installed"
puts "âœ… Applications: Restarted with new config"
puts "ğŸ” JWT Secret: 9=N6H//qQ\]?g+BDV"
puts "ğŸŒ Worker Token: after9b9fcaead55610e5dd235878e702ee69"
puts "ğŸ“± Ready for Supabase integration!"
puts "=========================================="

send "exit\r"
expect eof