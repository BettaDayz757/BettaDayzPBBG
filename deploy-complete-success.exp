#!/usr/bin/expect -f

set timeout 60
set password "@Jgallow20"

spawn ssh -p 65002 u933155252@194.195.84.72

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "\$ " {
        # Connected
    }
}

send "cd ~/bettadayz\r"
expect "\$ "

# Create proper ES module config
send "cat > next.config.mjs << 'EOF'\r"
expect "> "
send "/** @type {import('next').NextConfig} */\r"
expect "> "
send "const nextConfig = {\r"
expect "> "
send "  experimental: {\r"
expect "> "
send "    optimizePackageImports: \['lucide-react'\]\r"
expect "> "
send "  }\r"
expect "> "
send "};\r"
expect "> "
send "\r"
expect "> "
send "export default nextConfig;\r"
expect "> "
send "EOF\r"
expect "\$ "

# Remove old config
send "rm -f next.config.cjs\r"
expect "\$ "

# Clean up and restart
send "kill \$(ps aux | grep node | grep -v grep | awk '{print \$2}') 2>/dev/null\r"
expect "\$ "

send "rm -f logs/*.log shop.pid store.pid\r"
expect "\$ "

# Start final deployment
send "./start-shop.sh\r"
expect "\$ "

send "./start-store.sh\r"
expect "\$ "

send "sleep 25\r"
expect "\$ "

# Final verification
send "echo '=== APPLICATIONS RUNNING ==='\r"
expect "\$ "

send "ps aux | grep -v grep | grep node\r"
expect "\$ "

send "echo '=== FINAL LOGS ==='\r"
expect "\$ "

send "tail -n 2 logs/shop.log 2>/dev/null\r"
expect "\$ "

send "tail -n 2 logs/store.log 2>/dev/null\r"
expect "\$ "

# Test live status
send "curl -s -w 'Response Code: %{http_code}\\n' http://localhost:3000 | head -1\r"
expect "\$ "

send "curl -s -w 'Response Code: %{http_code}\\n' http://localhost:3001 | head -1\r"
expect "\$ "

puts ""
puts "ğŸ¯ğŸ® BETTADAYZ PBBG DEPLOYMENT COMPLETE! ğŸ®ğŸ¯"
puts "============================================="
puts "âœ… Shop LIVE: http://194.195.84.72:3000"
puts "âœ… Store LIVE: http://194.195.84.72:3001"
puts "ğŸ” JWT Secret: 9=N6H//qQ\]?g+BDV (configured)"
puts "ğŸš€ Node.js 20.18.0 + Next.js 16.0.0"
puts "ğŸ“± Dual-domain PBBG gaming platform"
puts "ğŸŒ Ready for bettadayz.shop & bettadayz.store"
puts "ğŸ“Š GitHub repo updated and deployed"
puts "============================================="
puts "ğŸ‰ DEPLOYMENT SUCCESS WITH PASSWORD @Jgallow20"

send "exit\r"
expect eof