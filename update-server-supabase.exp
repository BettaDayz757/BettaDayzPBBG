#!/usr/bin/expect -f

# Update BettaDayz PBBG Server with Supabase Configuration
# Supabase URL: https://btcfpizydmcdjhltwbil.supabase.co

set timeout 120
set password "@Jgallow20"
set supabase_url "https://btcfpizydmcdjhltwbil.supabase.co"
set jwt_secret "9=N6H//qQ]?g+BDV"

puts "🗄️ BettaDayz PBBG Supabase Server Configuration"
puts "================================================"
puts "🌐 Supabase URL: $supabase_url"
puts "🔐 JWT Secret: $jwt_secret"
puts "📝 Updating server environment variables..."
puts ""

# Connect to server
spawn ssh -p 65002 u933155252@194.195.84.72

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "Password:" {
        send "$password\r"
        exp_continue
    }
    "\$ " {
        # Connected
    }
    timeout {
        puts "Connection timeout"
        exit 1
    }
}

send "cd ~/bettadayz\r"
expect "\$ "

# Update shop environment
send "echo 'Updating shop environment with Supabase...'\r"
expect "\$ "

send "cp .env.production.shop .env.production.shop.backup\r"
expect "\$ "

send "cat > .env.production.shop << 'EOF'\r"
expect "> "
send "# BettaDayz PBBG Shop - Production Environment\r"
expect "> "
send "# Updated: Oct 29 2025\r"
expect "> "
send "\r"
expect "> "
send "# Server Configuration\r"
expect "> "
send "NODE_ENV=production\r"
expect "> "
send "PORT=3000\r"
expect "> "
send "GAME_DOMAIN=shop\r"
expect "> "
send "\r"
expect "> "
send "# JWT Configuration\r"
expect "> "
send "JWT_SECRET=$jwt_secret\r"
expect "> "
send "NEXTAUTH_SECRET=$jwt_secret\r"
expect "> "
send "\r"
expect "> "
send "# Supabase Configuration\r"
expect "> "
send "SUPABASE_URL=$supabase_url\r"
expect "> "
send "SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0Y2ZwaXp5ZG1jZGpobHR3YmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAyNDY3MDEsImV4cCI6MjA0NTgyMjcwMX0.placeholder\r"
expect "> "
send "SUPABASE_SERVICE_ROLE_KEY=service_role_placeholder\r"
expect "> "
send "DATABASE_URL=postgresql://postgres:\[PASSWORD\]@db.btcfpizydmcdjhltwbil.supabase.co:5432/postgres\r"
expect "> "
send "\r"
expect "> "
send "# Game Configuration\r"
expect "> "
send "ENABLE_CHAT=true\r"
expect "> "
send "ENABLE_AVATARS=true\r"
expect "> "
send "ENABLE_MARKETPLACE=true\r"
expect "> "
send "ENABLE_IN_APP_PURCHASES=true\r"
expect "> "
send "\r"
expect "> "
send "# Cloudflare Worker Integration\r"
expect "> "
send "WORKER_TOKEN=after9b9fcaead55610e5dd235878e702ee69\r"
expect "> "
send "\r"
expect "> "
send "# Payment Configuration\r"
expect "> "
send "ENABLE_CRYPTO_PAYMENTS=true\r"
expect "> "
send "ENABLE_CASHAPP_PAYMENTS=true\r"
expect "> "
send "BITCOIN_ADDRESS=bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\r"
expect "> "
send "CASHAPP_CASHTAG=\$BettaDayz757\r"
expect "> "
send "\r"
expect "> "
send "# GitHub OAuth\r"
expect "> "
send "GITHUB_CLIENT_ID=github_client_id_placeholder\r"
expect "> "
send "GITHUB_CLIENT_SECRET=github_client_secret_placeholder\r"
expect "> "
send "\r"
expect "> "
send "# Site Configuration\r"
expect "> "
send "NEXT_PUBLIC_SITE_URL=https://bettadayz.shop\r"
expect "> "
send "DOMAIN=bettadayz.shop\r"
expect "> "
send "LOCATION=Shop\r"
expect "> "
send "EOF\r"
expect "\$ "

# Update store environment
send "echo 'Updating store environment with Supabase...'\r"
expect "\$ "

send "cp .env.production.store .env.production.store.backup\r"
expect "\$ "

send "cat > .env.production.store << 'EOF'\r"
expect "> "
send "# BettaDayz PBBG Store - Production Environment\r"
expect "> "
send "# Updated: Oct 29 2025\r"
expect "> "
send "\r"
expect "> "
send "# Server Configuration\r"
expect "> "
send "NODE_ENV=production\r"
expect "> "
send "PORT=3001\r"
expect "> "
send "GAME_DOMAIN=store\r"
expect "> "
send "\r"
expect "> "
send "# JWT Configuration\r"
expect "> "
send "JWT_SECRET=$jwt_secret\r"
expect "> "
send "NEXTAUTH_SECRET=$jwt_secret\r"
expect "> "
send "\r"
expect "> "
send "# Supabase Configuration\r"
expect "> "
send "SUPABASE_URL=$supabase_url\r"
expect "> "
send "SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0Y2ZwaXp5ZG1jZGpobHR3YmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAyNDY3MDEsImV4cCI6MjA0NTgyMjcwMX0.placeholder\r"
expect "> "
send "SUPABASE_SERVICE_ROLE_KEY=service_role_placeholder\r"
expect "> "
send "DATABASE_URL=postgresql://postgres:\[PASSWORD\]@db.btcfpizydmcdjhltwbil.supabase.co:5432/postgres\r"
expect "> "
send "\r"
expect "> "
send "# Game Configuration\r"
expect "> "
send "ENABLE_CHAT=true\r"
expect "> "
send "ENABLE_AVATARS=true\r"
expect "> "
send "ENABLE_MARKETPLACE=true\r"
expect "> "
send "ENABLE_IN_APP_PURCHASES=true\r"
expect "> "
send "\r"
expect "> "
send "# Cloudflare Worker Integration\r"
expect "> "
send "WORKER_TOKEN=after9b9fcaead55610e5dd235878e702ee69\r"
expect "> "
send "\r"
expect "> "
send "# Payment Configuration\r"
expect "> "
send "ENABLE_CRYPTO_PAYMENTS=true\r"
expect "> "
send "ENABLE_CASHAPP_PAYMENTS=true\r"
expect "> "
send "BITCOIN_ADDRESS=bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh\r"
expect "> "
send "CASHAPP_CASHTAG=\$BettaDayz757\r"
expect "> "
send "\r"
expect "> "
send "# GitHub OAuth\r"
expect "> "
send "GITHUB_CLIENT_ID=github_client_id_placeholder\r"
expect "> "
send "GITHUB_CLIENT_SECRET=github_client_secret_placeholder\r"
expect "> "
send "\r"
expect "> "
send "# Site Configuration\r"
expect "> "
send "NEXT_PUBLIC_SITE_URL=https://bettadayz.store\r"
expect "> "
send "DOMAIN=bettadayz.store\r"
expect "> "
send "LOCATION=Store\r"
expect "> "
send "EOF\r"
expect "\$ "

# Update Supabase client configuration
send "echo 'Updating Supabase client configuration...'\r"
expect "\$ "

send "cat > lib/supabase-config.ts << 'EOF'\r"
expect "> "
send "// BettaDayz PBBG Supabase Configuration\r"
expect "> "
send "// Updated with production Supabase instance\r"
expect "> "
send "\r"
expect "> "
send "export const supabaseConfig = {\r"
expect "> "
send "  url: '$supabase_url',\r"
expect "> "
send "  anonKey: process.env.SUPABASE_ANON_KEY \|\| 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0Y2ZwaXp5ZG1jZGpobHR3YmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAyNDY3MDEsImV4cCI6MjA0NTgyMjcwMX0.placeholder',\r"
expect "> "
send "  serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY,\r"
expect "> "
send "  jwtSecret: '$jwt_secret'\r"
expect "> "
send "}\r"
expect "> "
send "\r"
expect "> "
send "export const databaseConfig = {\r"
expect "> "
send "  host: 'db.btcfpizydmcdjhltwbil.supabase.co',\r"
expect "> "
send "  port: 5432,\r"
expect "> "
send "  database: 'postgres',\r"
expect "> "
send "  user: 'postgres'\r"
expect "> "
send "}\r"
expect "> "
send "EOF\r"
expect "\$ "

# Restart applications with new configuration
send "echo 'Restarting applications with Supabase configuration...'\r"
expect "\$ "

send "kill \$(cat shop.pid store.pid 2>/dev/null) 2>/dev/null \|\| echo 'No processes to kill'\r"
expect "\$ "

send "sleep 5\r"
expect "\$ "

send "./start-shop.sh\r"
expect "\$ "

send "./start-store.sh\r"
expect "\$ "

send "sleep 15\r"
expect "\$ "

# Test the applications
send "echo '=== TESTING SUPABASE INTEGRATION ==='\r"
expect "\$ "

send "curl -s -o /dev/null -w 'Shop Response: %{http_code}\\n' http://localhost:3000/\r"
expect "\$ "

send "curl -s -o /dev/null -w 'Store Response: %{http_code}\\n' http://localhost:3001/\r"
expect "\$ "

send "curl -s -o /dev/null -w 'Game Page Response: %{http_code}\\n' http://localhost:3000/game\r"
expect "\$ "

send "echo '=== APPLICATION LOGS ==='\r"
expect "\$ "

send "tail -n 3 logs/shop.log\r"
expect "\$ "

send "tail -n 3 logs/store.log\r"
expect "\$ "

puts ""
puts "✅ SUPABASE SERVER CONFIGURATION COMPLETE!"
puts "=========================================="
puts "🌐 Supabase URL: $supabase_url"
puts "🔐 JWT Secret: $jwt_secret"
puts "✅ Shop Environment: Updated with Supabase"
puts "✅ Store Environment: Updated with Supabase"
puts "✅ Applications: Restarted with new config"
puts "📊 Database: Ready for schema deployment"
puts "🎮 Game Integration: Active"
puts "=========================================="

send "exit\r"
expect eof